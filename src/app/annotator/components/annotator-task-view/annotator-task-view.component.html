<mat-toolbar class="d-flex justify-content-center align-items-center">
  <button *ngIf="taskData" mat-flat-button [routerLink]="['/annotator']">
    <span class="d-flex align-items-center justify-content-center w-100">
      <mat-icon>keyboard_arrow_left</mat-icon>
      <h3>{{taskData.filename}}</h3>
    </span>
  </button>
</mat-toolbar>

<div *ngIf="taskData" class="container-fluid">
  <!-- <mat-toolbar color="primary">
    <span>Annotation task for file {{taskData.filename}}</span>
  </mat-toolbar> -->

  <div *ngIf="taskData.is_locked">
    <p>This task is locked. This means you shouldn't be working on it currently.</p>
  </div>

  <div *ngIf="!taskData.is_locked">

    <div class="row m-3">
      <div class="col-12">
        <div class="progress-row row d-flex align-items-center ml-3 pt-2 pl-1 mb-n2">
          <h3 style="color:var(--text-medium-light)">Task Information</h3>
        </div>
        <mat-card class="campaign-card m-3 p-4">

          <div>
            <p><strong>Assigned by:</strong> {{taskData.assigner.fullname}}</p>
            <p><strong>Created on:</strong> {{taskData.creation_time}}</p>
            <p><strong>Deadline:</strong> {{taskData.deadline ? taskData.deadline : 'None'}}</p>
            <p><strong>Task Type:</strong> {{taskData.task_type}}</p>
          </div>

        </mat-card>
      </div>
    </div>

    <div class="row m-3">
      <div class="col-12">
        <div class="progress-row row d-flex align-items-center ml-3 pt-2 pl-1 mb-n2">
          <h3 style="color:var(--text-medium-light)">Instructions</h3>
        </div>
        <mat-card class="campaign-card m-3 p-4">

          <div>
            <ng-template #stepcontent>
              <p>{{taskData.current_instructions}}</p>

              <div *ngIf="taskData.allow_starter_dl; then starterButton else currentTemplateButton">
              </div>
              <ng-template #starterButton>
                <button mat-raised-button (click)="downloadStarter()">Download</button>
              </ng-template>
              <ng-template #currentTemplateButton>
                <button mat-raised-button (click)="downloadCurrentTextGridTemplate()">Download</button>
              </ng-template>

            </ng-template>

            <mat-horizontal-stepper labelPosition="bottom" #stepper [selectedIndex]="taskData.current_step_idx">
              <mat-step *ngFor="let taskStatus of taskData.all_steps; index as i;" [label]="taskStatus"
                content="#stepcontent" [completed]="i <= taskData.current_step_idx">
                <ng-container *ngTemplateOutlet="stepcontent"></ng-container>
              </mat-step>
            </mat-horizontal-stepper>
          </div>

        </mat-card>
      </div>
    </div>


    <div *ngIf="taskData.allow_file_upload">
      <div class="row m-3">
        <div class="col-12">
          <div class="progress-row row d-flex align-items-center ml-3 pt-2 pl-1 mb-n2">
            <h3 style="color:var(--text-medium-light)">Submission</h3>
          </div>
          <mat-card class="campaign-card m-3 p-4">
            <div>
              <p>Once the file has been annotated, upload the file</p>
              <p>If there are any errors on the upload, correct the errors and upload again.</p>
              <p>You can check the validity of the file at all times (without actually saving it) by clicking 'Validate'
              </p>
              <form [formGroup]="uploadForm">
                <mat-form-field>
                  <ngx-mat-file-input formControlName="tgFile" placeholder="TextGrid Upload" [accept]="'.TextGrid'">
                  </ngx-mat-file-input>
                  <mat-icon matSuffix>insert_drive_file</mat-icon>
                  <mat-error *ngIf="uploadForm.get('tgFile').hasError('required')">
                    Please select a TextGrid file
                  </mat-error>
                </mat-form-field>
                <button mat-raised-button (click)="validateTextGrid()" color="primary">VALIDATE</button>
                <button mat-raised-button (click)="submitTextGrid()" color="accent">SUBMIT</button>
              </form>

            </div>

            <div *ngIf="tgErrors">
              <div *ngIf="tgErrors.structural">
                <h4>Structural Errors</h4>
                <mat-card *ngFor="let error of tgErrors.structural">
                  <mat-card-header>
                    <mat-icon mat-card-avatar aria-hidden="false">list</mat-icon>
                    <mat-card-title>Structural Error</mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <p>{{error.msg}}</p>
                  </mat-card-content>
                </mat-card>
              </div>

              <div *ngIf="tgErrors.annot">
                <h4>Annotation errors</h4>
                <div *ngFor="let annotErrors of tgErrors.annot | keyvalue">
                  <h5>For Tier {{annotErrors.key}}</h5>
                  <mat-card *ngFor="let error of annotErrors.value">
                    <mat-card-header>
                      <mat-icon mat-card-avatar aria-hidden="false">list</mat-icon>
                      <mat-card-title>
                        Annotation error in tier {{error.tier}}, interval #{{error.index}}
                        (from {{error.start}}s to {{error.end}}s)
                      </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                      <p>{{error.msg}}</p>
                    </mat-card-content>
                  </mat-card>
                </div>
              </div>

              <div *ngIf="tgErrors.annot_mismatch">
                <h4>Structural Errors</h4>
                <mat-card *ngFor="let error of tgErrors.annot_mismatch">
                  <mat-card-header>
                    <mat-icon mat-card-avatar aria-hidden="false">list</mat-icon>
                    <mat-card-title>
                      Annotation mismatch between tiers {{error.ref_tier}} and tier {{error.target_tier}}, interval
                      #{{error.index}}
                    </mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <p>The annotation {{error.ref_annot}} isn't the same as annot {{error.target_annot}}</p>
                  </mat-card-content>
                </mat-card>
              </div>

              <div *ngIf="tgErrors.time_conflict">
                <h4>Structural Errors</h4>
                <mat-card *ngFor="let error of tgErrors.time_conflict">
                  <mat-card-header>
                    <mat-icon mat-card-avatar aria-hidden="false">list</mat-icon>
                    <mat-card-title>
                      Can't merge annotations between intervals #{{error.index_before}} and #{{error.index_after}}
                      between tiers {{error.tier_a}} and {{error.tier_b}}
                    </mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <p>Impossible to merge frontiers between intervals #{{error.index_before}} and
                      #{{error.index_after}}.
                      The difference between the two frontiers ({{error.time_a}}s and {{error.tier_b}}s)
                      is bigger than the authorised threshold of {{error.threshold}}s.</p>
                  </mat-card-content>
                </mat-card>
              </div>
            </div>
          </mat-card>
        </div>
      </div>
    </div>


    <div *ngIf="taskData.frontiers_merge_table">
      <h3>Merging times mismatch</h3>

      <table mat-table [dataSource]="timesMergeMismatch" class="mat-elevation-2">

        <ng-container matColumnDef="tier_a">
          <th mat-header-cell *matHeaderCellDef> Tier A </th>
          <td mat-cell *matCellDef="let row"> {{row.tier_a}} </td>
        </ng-container>

        <ng-container matColumnDef="tier_b">
          <th mat-header-cell *matHeaderCellDef> Tier B </th>
          <td mat-cell *matCellDef="let row"> {{row.tier_b}} </td>
        </ng-container>

        <ng-container matColumnDef="time_a">
          <th mat-header-cell *matHeaderCellDef> Time A </th>
          <td mat-cell *matCellDef="let row"> {{row.time_a}} </td>
        </ng-container>

        <ng-container matColumnDef="time_b">
          <th mat-header-cell *matHeaderCellDef> Time B </th>
          <td mat-cell *matCellDef="let row"> {{row.time_b}} </td>
        </ng-container>

        <ng-container matColumnDef="index_before">
          <th mat-header-cell *matHeaderCellDef> Time Before</th>
          <td mat-cell *matCellDef="let row"> {{row.index_before}} </td>
        </ng-container>

        <ng-container matColumnDef="index_after">
          <th mat-header-cell *matHeaderCellDef> Index After </th>
          <td mat-cell *matCellDef="let row"> {{row.index_after}} </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="conflictsTableColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: conflictsTableColumns;"></tr>
      </table>




    </div>


    <h3>Comments</h3>

    <seshat-comments [taskID]="taskData.id"></seshat-comments>
  </div>
</div>
